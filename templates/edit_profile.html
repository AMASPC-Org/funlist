{% extends "base.html" %}
{% from "macros/_form_helpers.html" import render_field %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>My Profile</h2>
            <p class="text-muted">Manage your personal information and settings</p>

            <form method="POST" enctype="multipart/form-data">
                {{ form.hidden_tag() }}

                <!-- My Capabilities Section -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">My Capabilities</h5>
                        <p class="text-muted">Activate additional features based on your needs</p>
                        
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            {% if not current_user.is_event_creator %}
                            <button type="submit" name="activate_role" value="event_creator" class="btn btn-outline-success">
                                <i class="fas fa-calendar-plus"></i> Become an Event Creator
                            </button>
                            {% endif %}
                            
                            {% if not current_user.is_organizer %}
                            <button type="submit" name="activate_role" value="organizer" class="btn btn-outline-success">
                                <i class="fas fa-building"></i> Register as an Organizer
                            </button>
                            {% endif %}
                            
                            {% if not current_user.is_vendor %}
                            <button type="submit" name="activate_role" value="vendor" class="btn btn-outline-success">
                                <i class="fas fa-store"></i> Register as a Vendor
                            </button>
                            {% endif %}
                            
                            {% if not current_user.is_sponsor %}
                            <button type="submit" name="activate_role" value="sponsor" class="btn btn-outline-success">
                                <i class="fas fa-ad"></i> Become a Sponsor
                            </button>
                            {% endif %}
                        </div>
                        
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-info-circle"></i> Activating a new capability will reveal additional profile sections to complete.
                        </div>
                    </div>
                </div>

                <!-- Personal Information Section -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Personal Information</h5>
                        <div class="row">
                            <div class="col-md-6">
                                {{ render_field(form.first_name, class="form-control") }}
                                {{ render_field(form.last_name, class="form-control") }}
                                {{ render_field(form.title, class="form-control") }}
                            </div>
                            <div class="col-md-6">

                                {% if form.profile_image %}
                                <div class="mb-3">
                                    <label class="form-label">Profile Image</label>
                                    {% if current_user.profile_image %}
                                    <div class="mb-2">
                                        <img src="{{ current_user.profile_image }}" alt="Current Profile Image" class="img-thumbnail" style="max-width: 150px;">
                                    </div>
                                    {% endif %}
                                    {{ form.profile_image(class="form-control") }}
                                    {% if form.profile_image.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.profile_image.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Social Media Links Section -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Social Media Links</h5>
                        <div class="row">
                            <div class="col-md-6">
                                {{ render_field(form.facebook_url, class="form-control") }}
                                {{ render_field(form.instagram_url, class="form-control") }}
                                {{ render_field(form.twitter_url, class="form-control") }}
                            </div>
                            <div class="col-md-6">
                                {{ render_field(form.linkedin_url, class="form-control") }}
                                {{ render_field(form.tiktok_url, class="form-control") }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Organizer Information Section (conditional) -->
                {% if current_user.is_organizer %}
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Organizer Information</h5>
                        <div class="row">
                            <div class="col-md-6">
                                {{ render_field(form.company_name, class="form-control") }}
                                {{ render_field(form.organizer_description, class="form-control") }}
                                {{ render_field(form.business_street, class="form-control") }}
                                {{ render_field(form.business_city, class="form-control") }}
                            </div>
                            <div class="col-md-6">
                                {{ render_field(form.business_state, class="form-control") }}
                                {{ render_field(form.business_zip, class="form-control") }}
                                {{ render_field(form.business_phone, class="form-control") }}
                                {{ render_field(form.business_email, class="form-control") }}
                                {{ render_field(form.organizer_website, class="form-control") }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Venue Management Section (conditional) -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Venue Management</h5>
                        <p><small>Manage venues associated with your organization.</small></p>
                        <p class="alert alert-info">You can manage your venues in the Venues section.</p>

                        <a href="{{ url_for('add_venue') }}" class="btn btn-primary">Add New Venue</a>
                    </div>
                </div>
                {% endif %}

                <!-- Vendor Information Section (conditional) -->
                {% if current_user.is_vendor %}
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Vendor Information</h5>
                        <div class="row">
                            <div class="col-md-6">
                                {{ render_field(form.vendor_type, class="form-control") }}
                                {{ render_field(form.vendor_description, class="form-control") }}
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> Complete your vendor profile to be visible to event organizers.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Sponsor Information Section (conditional) -->
                {% if current_user.is_sponsor %}
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Sponsor Information</h5>
                        <div class="row">
                            <div class="col-md-6">
                                {{ render_field(form.sponsorship_interests, class="form-control") }}
                                {{ render_field(form.sponsorship_budget, class="form-control") }}
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info">
                                    <i class="fas fa-lightbulb"></i> Providing sponsorship details helps match you with relevant opportunities.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Account Settings Section -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Account Settings</h5>
                        <p><strong>Email:</strong> {{ current_user.email }}</p>
                        <p><strong>Membership Tier:</strong> {{ current_user.membership_tier.name if current_user.membership_tier else 'N/A' }}
                           <!-- Membership management coming soon -->
                        </p>
                        <a href="{{ url_for('change_password') }}" class="btn btn-secondary mt-2">Change Password</a>
                        <!-- Placeholder for future settings -->
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{{ url_for('profile') }}" class="btn btn-secondary me-md-2">Cancel</a>
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle role activation button confirmation
        const roleButtons = document.querySelectorAll('button[name="activate_role"]');
        
        roleButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                const roleName = this.value;
                let roleTitle;
                
                switch(roleName) {
                    case 'event_creator':
                        roleTitle = 'Event Creator';
                        break;
                    case 'organizer':
                        roleTitle = 'Organizer';
                        break;
                    case 'vendor':
                        roleTitle = 'Vendor';
                        break;
                    case 'sponsor':
                        roleTitle = 'Sponsor';
                        break;
                    default:
                        roleTitle = 'this role';
                }
                
                if (confirm(`Activate ${roleTitle} capabilities? This will add new sections to your profile to complete.`)) {
                    // Create a hidden form to submit the role activation
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = window.location.href;
                    
                    // Add CSRF token
                    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrf_token';
                    csrfInput.value = csrfToken;
                    form.appendChild(csrfInput);
                    
                    // Add role activation field
                    const roleInput = document.createElement('input');
                    roleInput.type = 'hidden';
                    roleInput.name = 'activate_role';
                    roleInput.value = roleName;
                    form.appendChild(roleInput);
                    
                    // Submit the form
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        });
    });
</script>
{% endblock %}