{% extends "base.html" %}
{% from "macros/_form_helpers.html" import render_field %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">{{ page_title or "Submit a New Event" }}</h1>

    <div class="row g-3 mb-4">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Live Summary</h5>
                        <span class="badge bg-secondary" id="liveSummaryStatus">Draft not saved</span>
                    </div>
                    <p class="text-muted small mb-3">Your event snapshot updates automatically while you type.</p>
                    <p class="fw-semibold mb-1" id="liveSummaryTitle">Name your event to get started</p>
                    <p class="text-muted mb-2" id="liveSummaryDates">Pick a start date to see it here</p>
                    <p class="mb-2" id="liveSummaryLocation">Location TBA</p>
                    <p class="mb-1"><strong>Category:</strong> <span id="liveSummaryCategory">Not selected</span></p>
                    <p class="mb-0"><strong>Audience:</strong> <span id="liveSummaryAudience">Not selected</span></p>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small mb-3">Quick Tips</h6>
                    <ul class="list-unstyled small mb-0">
                        <li class="mb-2"><i class="fas fa-magic text-warning me-2"></i>Lead with what makes your event unique.</li>
                        <li class="mb-2"><i class="fas fa-clock text-primary me-2"></i>Specific dates and times help guests commit.</li>
                        <li class="mb-2"><i class="fas fa-map-marker-alt text-danger me-2"></i>Add a landmark or neighborhood for flexible locations.</li>
                        <li class="mb-0"><i class="fas fa-eye text-success me-2"></i>Use Preview anytime to check the attendee view.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <form id="eventForm" method="POST" action="{{ form_action or url_for('submit_event') }}" class="mx-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    {{ form.hidden_tag() }}
    <div class="mb-3">
        {{ form.title.label(class="form-label") }}
        {{ form.title(class="form-control", maxlength="250", oninput="updateCharCount(this, 'titleCount', 250)") }}
        <small class="text-muted"><span id="titleCount">0</span>/250 characters</small>
    </div>
    <div class="mb-3">
        {{ form.description.label(class="form-label") }}
        {{ form.description(class="form-control", rows="5", maxlength="1500", oninput="updateCharCount(this, 'descriptionCount', 1500)") }}
        <small class="text-muted"><span id="descriptionCount">0</span>/1500 characters</small>
    </div>
    <div class="mb-3">
        {{ form.all_day.label(class="form-label") }}
        {{ form.all_day(class="form-check-input ms-2") }}
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
            {{ form.start_date.label(class="form-label") }}
            {{ form.start_date(class="form-control", type="date") }}
        </div>
        <div class="col-md-6">
            {{ form.end_date.label(class="form-label") }}
            {{ form.end_date(class="form-control", type="date") }}
        </div>
    </div>
    <div class="row mb-3 time-fields">
        <div class="col-md-6">
            {{ form.start_time.label(class="form-label") }}
            {{ form.start_time(class="form-control", type="time") }}
        </div>
        <div class="col-md-6">
            {{ form.end_time.label(class="form-label") }}
            {{ form.end_time(class="form-control", type="time") }}
        </div>
    </div>
    <div class="mb-3">
        {{ form.is_recurring.label(class="form-label") }}
        {{ form.is_recurring(class="form-check-input ms-2", id="is_recurring") }}
    </div>
    <div id="recurrenceFields" class="recurrence-fields" style="display: none;">
        <div class="mb-3">
            {{ form.recurrence_type.label(class="form-label") }}
            {{ form.recurrence_type(class="form-select", id="recurrence_type") }}
        </div>
        <div id="customRecurrenceFields" style="display: none;">
            <div class="mb-3">
                <label class="form-label">Repeat every</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="recurrence_interval" min="1" value="1">
                    <select class="form-select" id="recurrence_unit">
                        <option value="days">Days</option>
                        <option value="weeks">Weeks</option>
                        <option value="months">Months</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">End recurrence</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="recurrence_end_type" id="never_end" value="never" checked>
                <label class="form-check-label" for="never_end">Never</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="recurrence_end_type" id="end_after" value="after">
                <label class="form-check-label" for="end_after">After</label>
                <div class="input-group mt-2" style="width: 200px;">
                    <input type="number" class="form-control" id="occurrence_count" value="10" min="1" disabled>
                    <span class="input-group-text">occurrences</span>
                </div>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="recurrence_end_type" id="end_on_date" value="on_date">
                <label class="form-check-label" for="end_on_date">On date</label>
                <div class="mt-2">
                    {{ form.recurring_end_date(class="form-control", type="date", id="recurring_end_date", disabled=true) }}
                </div>
            </div>
        </div>
    </div>

    <!-- Venue Selection -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Venue Information</h5>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="venue_selection_type" id="venue_selection_existing" value="existing" {% if form.venue_selection_type.data == 'existing' %}checked{% endif %} onchange="toggleVenueSelection()">
                                <label class="form-check-label" for="venue_selection_existing">
                                    Select an existing venue
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="venue_selection_type" id="venue_selection_new" value="new" {% if form.venue_selection_type.data == 'new' %}checked{% endif %} onchange="toggleVenueSelection()">
                                <label class="form-check-label" for="venue_selection_new">
                                    Add a new venue
                                </label>
                            </div>
                        </div>

                        <div id="existing-venue-section" {% if form.venue_selection_type.data == 'new' %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="venue_id" class="form-label">{{ form.venue_id.label }}</label>
                                {{ form.venue_id(class="form-select") }}
                                {% if form.venue_id.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.venue_id.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="mt-2">
                                    <a href="{{ url_for('add_venue') }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                        Add a venue to the database
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div id="new-venue-section" {% if form.venue_selection_type.data != 'new' %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label class="form-label">Find the venue with maps</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-map-marker-alt text-danger"></i></span>
                                    <input type="text" id="venuePlaceSearch" class="form-control" placeholder="Search for an address or venue">
                                    <button type="button" class="btn btn-outline-secondary" id="clearVenueSearch">Clear</button>
                                </div>
                                <small class="text-muted d-block mt-1">Pick a place to auto-fill the venue address fields below.</small>
                                <div id="venueMap" class="mt-3 border rounded" style="height: 260px;"></div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    {{ render_field(form.venue_name, class="form-control") }}
                                </div>
                                <div class="col-md-12">
                                    {{ render_field(form.venue_street, class="form-control") }}
                                </div>
                                <div class="col-md-4">
                                    {{ render_field(form.venue_city, class="form-control") }}
                                </div>
                                <div class="col-md-4">
                                    {{ render_field(form.venue_state, class="form-control") }}
                                </div>
                                <div class="col-md-4">
                                    {{ render_field(form.venue_zip, class="form-control") }}
                                </div>
                                <div class="col-md-6">
                                    {{ render_field(form.venue_latitude, class="form-control", placeholder="Latitude (auto-filled)") }}
                                </div>
                                <div class="col-md-6">
                                    {{ render_field(form.venue_longitude, class="form-control", placeholder="Longitude (auto-filled)") }}
                                </div>
                                <div class="col-md-12">
                                    {{ render_field(form.venue_type_id, class="form-select") }}
                                </div>
                                <div class="col-md-12">
                                    <div class="form-check mt-3">
                                        {{ form.use_new_venue(class="form-check-input") }}
                                        {{ form.use_new_venue.label(class="form-check-label") }}
                                        <small class="form-text text-muted d-block">
                                            Check this to save this venue to the database for future events
                                        </small>
                                    </div>
                                    <div class="form-check mt-2">
                                        {{ form.is_venue_owner(class="form-check-input") }}
                                        {{ form.is_venue_owner.label(class="form-check-label") }}
                                        <small class="form-text text-muted d-block">
                                            Check this if you are the owner, manager, or an authorized representative of this venue
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Location Details (only if not using venue) -->
                <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title d-flex justify-content-between align-items-center">
                                Additional Location Details
                                <span class="badge bg-light text-muted border">Optional</span>
                            </h5>
                            <p class="text-muted small mb-3">Add any extra context attendees should know once they get to the venue (e.g., “Meet near the park fountain”).</p>
                            <div class="row">
                                <div class="col-md-12">
                                    {{ render_field(form.street, class="form-control") }}
                                </div>
                            <div class="col-md-4">
                                {{ render_field(form.city, class="form-control") }}
                            </div>
                            <div class="col-md-4">
                                {{ render_field(form.state, class="form-control") }}
                            </div>
                            <div class="col-md-4">
                                {{ render_field(form.zip_code, class="form-control") }}
                            </div>
                        </div>
                    </div>
                </div>

    <div class="mb-3">
        {{ form.category.label(class="form-label") }}
        {{ form.category(class="form-select") }}
    </div>
    <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
            {{ form.target_audience.label(class="form-label mb-0") }}
            <small class="text-muted ms-2">Helps match your listing to the right attendees</small>
        </div>
        {{ form.target_audience(class="form-select") }}
    </div>
    <div class="mb-3">
        {{ form.fun_meter.label(class="form-label") }}
        {{ form.fun_meter(class="form-control", type="number", min="1", max="5") }}
    </div>

    <div class="mb-3">
        {{ form.prohibited_advertisers.label(class="form-label") }}
        <div class="form-text mb-2">Select categories of advertisers that should not be allowed to participate in this event</div>
        {{ form.prohibited_advertisers(class="form-select", multiple="multiple", size="7") }}
        <div class="mt-2">
            <a href="#" data-bs-toggle="modal" data-bs-target="#prohibitedInfoModal">Learn More</a> about advertiser categories
        </div>
    </div>

    <!-- Prohibited Advertisers Info Modal -->
    <div class="modal fade" id="prohibitedInfoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">About Prohibited Advertisers</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>You can exclude certain types of advertisers from participating in your event:</p>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">Alcohol and Tobacco - Bars, liquor stores, tobacco shops</li>
                        <li class="list-group-item">Cannabis - Dispensaries and related products</li>
                        <li class="list-group-item">Gambling - Casinos, betting services, lottery</li>
                        <li class="list-group-item">Adult Entertainment - Adult venues and products</li>
                        <li class="list-group-item">Junk Food - Fast food, sugary snacks and drinks</li>
                        <li class="list-group-item">Energy Drinks - High-caffeine beverages</li>
                        <li class="list-group-item">Political/Religious - Political campaigns, religious organizations</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it</button>
                </div>
            </div>
        </div>
    </div>
    <div class="mb-3">
        {{ form.ticket_url.label(class="form-label") }}
        {{ form.ticket_url(class="form-control") }}
    </div>

    <div class="mb-4">
        <div class="form-check mb-3">
                    {{ form.network_opt_out(class="form-check-input") }}
                    <label class="form-check-label" for="network_opt_out">
                        Opt out of sharing this event across the American Marketing Alliance SPC Network sites 
                        <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="By default, your event may be shared on BusinessCalendar.ai, DateCalendar.ai, FindLiveMusic.ai, PopHappyHour.com, and TacoNight.ai when appropriate"></i>
                    </label>
                </div>
        <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="terms_accepted" name="terms_accepted">
                    <label class="form-check-label" for="terms_accepted">
                    <label class="form-check-label" for="terms_accepted">
                        I accept the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms and Conditions</a>
                    </label>
                    {% if form.terms_accepted.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.terms_accepted.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Terms and Conditions Modal -->
                <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="termsModalLabel">Event Submission Terms and Conditions</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Content for the Event Submission Terms Modal/Section -->
                                <h4>Event Submission Terms and Conditions</h4>
                                <p>By submitting an event to FunList.ai, you agree to the following terms and conditions:</p>
                                <ol>
                                    <li><strong>Accuracy:</strong> You represent and warrant that all information provided about the event (including title, description, dates, times, location, and any images or links) is accurate, complete, and truthful to the best of your knowledge.</li>
                                    <li><strong>Rights and Permissions:</strong> You represent and warrant that you have the full right, power, and authority to submit this event information and grant FunList.ai the necessary licenses to display it. This includes obtaining any necessary permissions from venue owners, performers, or other rights holders.</li>
                                    <li><strong>Content Responsibility:</strong> You are solely responsible for the content of your event listing. FunList.ai acts as a platform for discovery and does not endorse or verify the details of submitted events.</li>
                                    <li><strong>Compliance with Laws:</strong> You agree that the event itself, and the content of your listing, will comply with all applicable local, state, federal, and international laws and regulations. Events promoting illegal activities are strictly prohibited.</li>
                                    <li><strong>Prohibited Content:</strong> You agree not to submit listings that contain hateful, defamatory, obscene, infringing, or otherwise objectionable content. FunList.ai reserves the right to define "objectionable" at its sole discretion.</li>
                                    <li><strong>Moderation Rights:</strong> FunList.ai reserves the right, at its sole discretion, to review, edit, reject, or remove any event listing at any time, for any reason, without prior notice. This includes listings deemed inaccurate, inappropriate, promotional (rather than event-focused), or otherwise not aligned with the platform's purpose.</li>
                                    <li><strong>License Grant:</strong> By submitting your event, you grant FunList.ai a non-exclusive, worldwide, royalty-free license to use, reproduce, display, distribute, and modify the submitted content (including text and images) in connection with the operation and promotion of the FunList.ai platform.</li>
                                    <li><strong>Network Distribution:</strong> By default, your event may be shared across the American Marketing Alliance SPC Network of websites, which includes BusinessCalendar.ai, DateCalendar.ai, FindLiveMusic.ai, PopHappyHour.com, and TacoNight.ai, when appropriate for the event type. You may opt out of this network distribution by indicating your preference during the submission process. For example, a family farm event with live music and food vendors may be featured on multiple network sites to maximize exposure, unless you choose to opt out.</li>
                                    <li><strong>Indemnification:</strong> You agree to indemnify and hold harmless FunList.ai, its parent company (American Marketing Alliance SPC), affiliates, officers, and employees from any claim or demand, including reasonable attorneys' fees, made by any third party due to or arising out of your event submission, your event itself, or your violation of these terms.</li>
                                    <li><strong>Disclaimer:</strong> FunList.ai provides this platform as a service and is not responsible for the execution, safety, quality, or cancellation of any listed event. Attendees participate at their own risk.</li>
                                    <li><strong>Full Terms and Privacy:</strong> Your use of FunList.ai is also governed by our main <a href="{{ url_for('terms') }}" target="_blank">Terms of Service</a> and <a href="{{ url_for('privacy') }}" target="_blank">Privacy Policy</a>. Please review them carefully.</li>
                                </ol>
                                <p><em>Submission of an event does not guarantee its publication on FunList.ai or any affiliated network sites.</em></p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
    </div>

    <div class="d-flex flex-wrap gap-3 justify-content-start mt-4 mb-5">
        {{ form.submit(class="btn btn-primary px-4", id="submitBtn") }}
        <button type="button" class="btn btn-outline-primary px-4" id="previewBtn">Preview</button>
        <button type="button" class="btn btn-outline-secondary px-4" id="saveAsDraftBtn">Save Draft</button>
        <button type="button" class="btn btn-outline-danger px-4" id="clearFormBtn">
            <i class="fas fa-trash-alt me-2"></i>Clear
        </button>
    </div>
</form>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Event Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewContent">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="submitFromPreview">Submit Event</button>
            </div>
        </div>
    </div>
</div>


{% block extra_js %}
<script>
window.updateCharCount = function(input, counterId, maxLength) {
    if (!input) return;
    const counter = document.getElementById(counterId);
    if (counter) {
        counter.textContent = input.value.length;
    }
    const helper = input.nextElementSibling;
    if (helper && helper.classList) {
        if (maxLength && input.value.length > maxLength * 0.9) {
            helper.classList.add('text-warning');
        } else {
            helper.classList.remove('text-warning');
        }
    }
};

window.toggleVenueSelection = function() {
    const existingVenueRadio = document.getElementById('venue_selection_existing');
    const existingVenueSection = document.getElementById('existing-venue-section');
    const newVenueSection = document.getElementById('new-venue-section');
    const mapSearchInput = document.getElementById('venuePlaceSearch');

    if (!existingVenueRadio || !existingVenueSection || !newVenueSection) {
        return;
    }

    if (existingVenueRadio.checked) {
        existingVenueSection.style.display = 'block';
        newVenueSection.style.display = 'none';
    } else {
        existingVenueSection.style.display = 'none';
        newVenueSection.style.display = 'block';
        if (typeof window.ensureVenueMap === 'function') {
            window.ensureVenueMap();
        }
        if (mapSearchInput) {
            try {
                mapSearchInput.focus({ preventScroll: true });
            } catch (focusError) {
                mapSearchInput.focus();
            }
        }
        if (venueMapInstance && window.google && google.maps) {
            setTimeout(() => {
                try {
                    google.maps.event.trigger(venueMapInstance, 'resize');
                    venueMapInstance.setCenter(venueMapInstance.getCenter() || VENUE_MAP_DEFAULT_CENTER);
                } catch (err) {
                    console.warn('Could not refresh venue map view', err);
                }
            }, 150);
        }
    }
};

const VENUE_MAP_DEFAULT_CENTER = { lat: 47.0379, lng: -122.9007 };
let venueMapInstance = null;
let venueMapMarker = null;
let venueMapAutocomplete = null;
let venueMapGeocoder = null;
let venueMapInitialized = false;

const getVenueFieldValue = (id) => {
    const el = document.getElementById(id);
    return el ? el.value.trim() : '';
};

const setVenueFieldValue = (id, value) => {
    const el = document.getElementById(id);
    if (!el || value === undefined || value === null) return;
    el.value = value;
    el.dispatchEvent(new Event('input', { bubbles: true }));
    el.dispatchEvent(new Event('change', { bubbles: true }));
};

const parseVenueAddressComponents = (components = []) => {
    const parsed = { street: '', city: '', state: '', zip: '' };
    let streetNumber = '';
    let route = '';

    components.forEach(component => {
        if (!component || !component.types) return;
        if (component.types.includes('street_number')) streetNumber = component.long_name;
        if (component.types.includes('route')) route = component.long_name;
        if (component.types.includes('locality') && !parsed.city) parsed.city = component.long_name;
        if (component.types.includes('postal_town') && !parsed.city) parsed.city = component.long_name;
        if (component.types.includes('administrative_area_level_2') && !parsed.city) parsed.city = component.long_name;
        if (component.types.includes('administrative_area_level_1')) parsed.state = component.short_name || component.long_name;
        if (component.types.includes('postal_code')) parsed.zip = component.long_name;
    });

    parsed.street = [streetNumber, route].filter(Boolean).join(' ').trim();
    return parsed;
};

const placeVenueMarker = (location, title = 'Selected location') => {
    if (!location || !venueMapInstance || !window.google || !google.maps) return;
    if (venueMapMarker) {
        venueMapMarker.setMap(null);
    }
    venueMapMarker = new google.maps.Marker({
        position: location,
        map: venueMapInstance,
        title
    });
    venueMapInstance.panTo(location);
};

const applyPlaceToVenueForm = (place) => {
    if (!place) return;
    const address = parseVenueAddressComponents(place.address_components || []);
    const currentName = getVenueFieldValue('venue_name');

    if (place.name && !currentName) {
        setVenueFieldValue('venue_name', place.name);
    } else if (!currentName && place.formatted_address) {
        setVenueFieldValue('venue_name', place.formatted_address);
    }
    if (address.street) setVenueFieldValue('venue_street', address.street);
    if (address.city) setVenueFieldValue('venue_city', address.city);
    if (address.state) setVenueFieldValue('venue_state', address.state);
    if (address.zip) setVenueFieldValue('venue_zip', address.zip);
    if (!address.street && place.formatted_address) {
        setVenueFieldValue('venue_street', place.formatted_address);
    }

    if (place.geometry && place.geometry.location) {
        const loc = place.geometry.location;
        const coords = typeof loc.lat === 'function'
            ? { lat: loc.lat(), lng: loc.lng() }
            : loc;
        setVenueFieldValue('venue_latitude', coords.lat);
        setVenueFieldValue('venue_longitude', coords.lng);
        placeVenueMarker(coords, place.name || 'Selected location');
    }
};

const reverseLookupVenueLocation = (latLng) => {
    if (!venueMapGeocoder || !latLng) return;
    venueMapGeocoder.geocode({ location: latLng }, (results, status) => {
        if (status === 'OK' && results && results[0]) {
            const result = results[0];
            applyPlaceToVenueForm({
                ...result,
                geometry: { location: latLng }
            });
            setVenueFieldValue('venuePlaceSearch', result.formatted_address || '');
        } else {
            placeVenueMarker(latLng);
        }
    });
};

const initVenueMapSelector = () => {
    if (venueMapInitialized) return;
    const mapElement = document.getElementById('venueMap');
    const searchInput = document.getElementById('venuePlaceSearch');
    if (!mapElement || !searchInput) return;

    venueMapGeocoder = new google.maps.Geocoder();
    venueMapInstance = new google.maps.Map(mapElement, {
        center: VENUE_MAP_DEFAULT_CENTER,
        zoom: 12,
        streetViewControl: false,
        mapTypeControl: false,
        fullscreenControl: true
    });

    venueMapAutocomplete = new google.maps.places.Autocomplete(searchInput, {
        fields: ['address_components', 'formatted_address', 'geometry', 'name'],
        types: ['geocode', 'establishment']
    });
    venueMapAutocomplete.addListener('place_changed', () => {
        const place = venueMapAutocomplete.getPlace();
        if (!place || !place.geometry) {
            return;
        }
        applyPlaceToVenueForm(place);
    });

    venueMapInstance.addListener('click', event => {
        const clickedLocation = event.latLng;
        if (!clickedLocation) return;
        placeVenueMarker({ lat: clickedLocation.lat(), lng: clickedLocation.lng() });
        reverseLookupVenueLocation(clickedLocation);
    });

    venueMapInitialized = true;
};

const loadGooglePlacesForVenue = () => {
    if (venueMapInitialized) return;
    const startInit = () => {
        if (!venueMapInitialized) {
            initVenueMapSelector();
        }
    };

    if (window.google && google.maps && google.maps.places) {
        startInit();
        return;
    }

    const existingScript = document.querySelector('script[data-venue-places-loader]');
    if (existingScript) {
        existingScript.addEventListener('load', startInit, { once: true });
        return;
    }

    const script = document.createElement('script');
    script.src = "https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&libraries=places";
    script.async = true;
    script.defer = true;
    script.setAttribute('data-venue-places-loader', 'true');
    script.onload = startInit;
    script.onerror = () => console.error('Failed to load Google Maps');
    document.head.appendChild(script);
};

window.ensureVenueMap = loadGooglePlacesForVenue;

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('eventForm');
    if (!form) {
        return;
    }

    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const startTimeInput = document.getElementById('start_time');
    const endTimeInput = document.getElementById('end_time');
    const titleInput = document.getElementById('title');
    const descriptionInput = document.getElementById('description');
    const previewBtn = document.getElementById('previewBtn');
    const previewModalEl = document.getElementById('previewModal');
    const previewContent = document.getElementById('previewContent');
    const submitFromPreview = document.getElementById('submitFromPreview');
    const saveAsDraftBtn = document.getElementById('saveAsDraftBtn');
    const clearFormBtn = document.getElementById('clearFormBtn');
    const categoryField = document.getElementById('category');
    const targetAudienceField = document.getElementById('target_audience');
    const venueSelect = document.getElementById('venue_id');
    const venueNameInput = document.getElementById('venue_name');
    const venuePlaceSearch = document.getElementById('venuePlaceSearch');
    const clearVenueSearchBtn = document.getElementById('clearVenueSearch');
    const newVenueRadio = document.getElementById('venue_selection_new');
    const isRecurringCheckbox = document.getElementById('is_recurring');
    const recurrenceFields = document.getElementById('recurrenceFields');
    const recurrenceType = document.getElementById('recurrence_type');
    const customRecurrenceFields = document.getElementById('customRecurrenceFields');
    const neverEndRadio = document.getElementById('never_end');
    const endAfterRadio = document.getElementById('end_after');
    const endOnDateRadio = document.getElementById('end_on_date');
    const occurrenceCount = document.getElementById('occurrence_count');
    const recurringEndDate = document.getElementById('recurring_end_date');
    const isSubEventCheckbox = document.getElementById('is_sub_event');
    const subEventFields = document.getElementById('sub-event-fields');
    const liveSummaryTitle = document.getElementById('liveSummaryTitle');
    const liveSummaryDates = document.getElementById('liveSummaryDates');
    const liveSummaryLocation = document.getElementById('liveSummaryLocation');
    const liveSummaryCategory = document.getElementById('liveSummaryCategory');
    const liveSummaryAudience = document.getElementById('liveSummaryAudience');
    const liveSummaryStatus = document.getElementById('liveSummaryStatus');

    const previewModal = previewModalEl && window.bootstrap ? new bootstrap.Modal(previewModalEl) : null;

    const readFieldValue = (id) => {
        const node = document.getElementById(id);
        return node ? node.value.trim() : '';
    };

    const getSelectedText = (selectEl) => {
        if (!selectEl || !selectEl.options.length || !selectEl.value) {
            return '';
        }
        const option = selectEl.options[selectEl.selectedIndex];
        return option ? option.textContent.trim() : '';
    };

    const buildLocationString = () => {
        const locationParts = ['street', 'city', 'state', 'zip_code']
            .map(readFieldValue)
            .filter(Boolean);

        if (locationParts.length) {
            return locationParts.join(', ');
        }

        const newVenueParts = ['venue_street', 'venue_city', 'venue_state', 'venue_zip']
            .map(readFieldValue)
            .filter(Boolean);

        if (newVenueParts.length) {
            return newVenueParts.join(', ');
        }

        if (venueSelect && venueSelect.selectedIndex > 0) {
            return venueSelect.options[venueSelect.selectedIndex].textContent.trim();
        }

        if (venueNameInput && venueNameInput.value.trim()) {
            return venueNameInput.value.trim();
        }

        return '';
    };

    const formatDateRange = () => {
        const startDate = startDateInput ? startDateInput.value : '';
        const endDate = (endDateInput ? endDateInput.value : '') || startDate;

        if (!startDate) {
            return 'Date TBA';
        }

        const dateSegment = endDate && endDate !== startDate ? `${startDate} → ${endDate}` : startDate;
        const startTime = startTimeInput ? startTimeInput.value : '';
        const endTime = endTimeInput ? endTimeInput.value : '';

        if (startTime || endTime) {
            const times = [startTime, endTime].filter(Boolean).join('–');
            return `${dateSegment} (${times})`;
        }

        return dateSegment;
    };

    const setSummaryStatus = (text, badgeClass = 'bg-secondary') => {
        if (!liveSummaryStatus) return;
        liveSummaryStatus.textContent = text;
        liveSummaryStatus.className = `badge ${badgeClass}`;
    };

    const updateSummary = () => {
        if (liveSummaryTitle) {
            liveSummaryTitle.textContent = titleInput && titleInput.value.trim()
                ? titleInput.value.trim()
                : 'Name your event to get started';
        }

        if (liveSummaryDates) {
            liveSummaryDates.textContent = formatDateRange();
        }

        if (liveSummaryLocation) {
            const location = buildLocationString();
            liveSummaryLocation.textContent = location || 'Location TBA';
        }

        if (liveSummaryCategory) {
            const category = getSelectedText(categoryField);
            liveSummaryCategory.textContent = category || 'Not selected';
        }

        if (liveSummaryAudience) {
            const audience = getSelectedText(targetAudienceField);
            liveSummaryAudience.textContent = audience || 'Not selected';
        }
    };

    const syncEndDate = () => {
        if (!startDateInput || !endDateInput) return;
        if (!endDateInput.value || endDateInput.value < startDateInput.value) {
            endDateInput.value = startDateInput.value;
        }
        updateSummary();
    };

    const updateRecurrenceVisibility = () => {
        if (!recurrenceFields || !isRecurringCheckbox) return;
        recurrenceFields.style.display = isRecurringCheckbox.checked ? 'block' : 'none';
    };

    const updateCustomRecurrenceVisibility = () => {
        if (!customRecurrenceFields || !recurrenceType) return;
        customRecurrenceFields.style.display = recurrenceType.value === 'custom' ? 'block' : 'none';
    };

    const handleRecurrenceRadioChange = () => {
        if (neverEndRadio && neverEndRadio.checked) {
            if (occurrenceCount) occurrenceCount.disabled = true;
            if (recurringEndDate) recurringEndDate.disabled = true;
        } else if (endAfterRadio && endAfterRadio.checked) {
            if (occurrenceCount) occurrenceCount.disabled = false;
            if (recurringEndDate) recurringEndDate.disabled = true;
        } else if (endOnDateRadio && endOnDateRadio.checked) {
            if (recurringEndDate) recurringEndDate.disabled = false;
            if (occurrenceCount) occurrenceCount.disabled = true;
        }
    };

    const updateSubEventVisibility = () => {
        if (!isSubEventCheckbox || !subEventFields) return;
        subEventFields.style.display = isSubEventCheckbox.checked ? 'block' : 'none';
    };

    const escapeHtml = (value = '') => value
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

    const getFunMeterValue = () => {
        const checked = form.querySelector('input[name="fun_meter"]:checked');
        return checked ? parseInt(checked.value, 10) || 0 : 0;
    };

    const openPreview = () => {
        if (!previewContent) return;
        const funMeterValue = Math.min(getFunMeterValue(), 5);
        const funStars = funMeterValue ? '⭐'.repeat(funMeterValue) : 'Not rated yet';
        const description = descriptionInput && descriptionInput.value
            ? escapeHtml(descriptionInput.value).replace(/\n/g, '<br>')
            : '<em>No description added yet.</em>';
        const category = getSelectedText(categoryField) || 'Category pending';
        const audience = getSelectedText(targetAudienceField) || 'General attendees';
        const location = buildLocationString() || 'Location TBA';
        const ticketUrl = readFieldValue('ticket_url');
        const ticketMarkup = ticketUrl
            ? `<li><strong>Tickets:</strong> <a href="${escapeHtml(ticketUrl)}" target="_blank" rel="noopener">${escapeHtml(ticketUrl)}</a></li>`
            : '';

        previewContent.innerHTML = `
            <div class="event-preview">
                <h3 class="mb-1">${escapeHtml(titleInput && titleInput.value ? titleInput.value : 'Untitled Event')}</h3>
                <p class="text-muted mb-3">${formatDateRange()}</p>
                <p class="mb-3">${description}</p>
                <ul class="list-unstyled small mb-0">
                    <li><strong>Location:</strong> ${escapeHtml(location)}</li>
                    <li><strong>Category:</strong> ${escapeHtml(category)}</li>
                    <li><strong>Audience:</strong> ${escapeHtml(audience)}</li>
                    <li><strong>Fun Meter:</strong> ${funStars}</li>
                    ${ticketMarkup}
                </ul>
            </div>
        `;

        if (previewModal) {
            previewModal.show();
        }
    };

    const saveDraft = async () => {
        if (!saveAsDraftBtn) return;
        const originalContent = saveAsDraftBtn.innerHTML;
        saveAsDraftBtn.disabled = true;
        saveAsDraftBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

        try {
            const formData = new FormData(form);
            formData.append('is_draft', 'true');
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData
            });

            const contentType = response.headers.get('content-type') || '';
            if (!response.ok || !contentType.includes('application/json')) {
                throw new Error('Unexpected response');
            }

            const payload = await response.json();
            if (payload.status != 'saved') {
                throw new Error('Draft was not saved');
            }

            setSummaryStatus('Draft saved', 'bg-success');
        } catch (error) {
            console.error('Error saving draft:', error);
            setSummaryStatus('Save failed', 'bg-danger');
        } finally {
            saveAsDraftBtn.disabled = false;
            saveAsDraftBtn.innerHTML = originalContent;
        }
    };

    const clearForm = () => {
        if (!confirm('Are you sure you want to clear the form?')) {
            return;
        }
        form.reset();
        syncEndDate();
        updateSummary();
        if (titleInput) {
            window.updateCharCount(titleInput, 'titleCount', 250);
        }
        if (descriptionInput) {
            window.updateCharCount(descriptionInput, 'descriptionCount', 1500);
        }
        setSummaryStatus('Draft not saved', 'bg-secondary');
        toggleVenueSelection();
    };

    if (titleInput) {
        window.updateCharCount(titleInput, 'titleCount', 250);
    }
    if (descriptionInput) {
        window.updateCharCount(descriptionInput, 'descriptionCount', 1500);
    }

    form.addEventListener('input', updateSummary);
    form.addEventListener('change', updateSummary);
    if (startDateInput) {
        startDateInput.addEventListener('change', syncEndDate);
    }
    if (previewBtn) {
        previewBtn.addEventListener('click', openPreview);
    }
    if (submitFromPreview) {
        submitFromPreview.addEventListener('click', () => form.submit());
    }
    if (saveAsDraftBtn) {
        saveAsDraftBtn.addEventListener('click', saveDraft);
    }
    if (clearFormBtn) {
        clearFormBtn.addEventListener('click', clearForm);
    }

    if (isRecurringCheckbox) {
        isRecurringCheckbox.addEventListener('change', updateRecurrenceVisibility);
        updateRecurrenceVisibility();
    }

    if (recurrenceType) {
        recurrenceType.addEventListener('change', updateCustomRecurrenceVisibility);
    }
    updateCustomRecurrenceVisibility();

    if (neverEndRadio) {
        neverEndRadio.addEventListener('change', handleRecurrenceRadioChange);
    }
    if (endAfterRadio) {
        endAfterRadio.addEventListener('change', handleRecurrenceRadioChange);
    }
    if (endOnDateRadio) {
        endOnDateRadio.addEventListener('change', handleRecurrenceRadioChange);
    }
    handleRecurrenceRadioChange();

    if (isSubEventCheckbox) {
        isSubEventCheckbox.addEventListener('change', updateSubEventVisibility);
    }
    updateSubEventVisibility();

    if (venuePlaceSearch) {
        venuePlaceSearch.addEventListener('focus', () => {
            if (typeof window.ensureVenueMap === 'function') {
                window.ensureVenueMap();
            }
        });
    }

    if (clearVenueSearchBtn && venuePlaceSearch) {
        clearVenueSearchBtn.addEventListener('click', () => {
            venuePlaceSearch.value = '';
            if (venueMapMarker) {
                venueMapMarker.setMap(null);
                venueMapMarker = null;
            }
            ['venue_latitude', 'venue_longitude'].forEach(id => setVenueFieldValue(id, ''));
        });
    }

    if (newVenueRadio && newVenueRadio.checked && typeof window.ensureVenueMap === 'function') {
        window.ensureVenueMap();
    }

    toggleVenueSelection();
    syncEndDate();
    updateSummary();
    setSummaryStatus('Draft not saved', 'bg-secondary');
});
</script>
{% endblock %}
{% endblock %}
