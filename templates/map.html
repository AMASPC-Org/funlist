{% extends "base.html" %}

{% block title %}Find Events Near You - Map | FunList.ai{% endblock %}

{% block head %}
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
        z-index: 1;
        border: 1px solid #ddd;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .filter-bar {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .map-container {
        position: relative;
    }

    .user-location-button {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .event-cards-container {
        max-height: 600px;
        overflow-y: auto;
        padding-right: 5px;
    }

    .event-card {
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
        margin-bottom: 15px;
        border-radius: 8px;
        background-color: white;
    }

    .event-card:hover {
        background-color: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        cursor: pointer;
    }

    .event-card.highlighted {
        background-color: #e9ecef;
        border-left-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .advertisement-card {
        background-color: #fff3cd;
        border: 1px dashed #007bff;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    .advertisement-card .ad-label {
        font-size: 0.9em;
        color: #6c757d;
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
  <div class="filter-container p-3 bg-light border-bottom shadow-sm">
    <div class="row align-items-center">
        <div class="col-md-3">
            <input type="text" class="form-control" id="locationSearch" placeholder="Search location...">
        </div>
        <div class="col-md-2">
            <select class="form-select" id="categoryFilter">
                <option selected>All Categories</option>
                <option>Sports</option>
                <option>Music</option>
                <option>Arts</option>
                <option>Food</option>
                <option>Other</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="dateFilter">
                <option selected>Any Date</option>
                <option>Today</option>
                <option>Tomorrow</option>
                <option>This Weekend</option>
                <option>Next Week</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="funFilter">
                <option selected>All Fun Ratings</option>
                <option value="5">⭐⭐⭐⭐⭐ (5)</option>
                <option value="4">⭐⭐⭐⭐ (4+)</option>
                <option value="3">⭐⭐⭐ (3+)</option>
            </select>
        </div>
        <div class="col-md-2">
            <button id="applyFilters" class="btn btn-primary w-100">Apply Filters</button>
        </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
        <div id="map" class="map-container shadow"></div>
    </div>

    <div class="col-lg-4">
        <div class="event-cards-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Map Events</h4>
                <div>
                    <span class="badge bg-primary" id="event-count">0 Events</span>
                </div>
            </div>

            <div id="visible-events-container">
                <div class="text-center text-muted py-4" id="no-events-message">
                    <i class="fas fa-map-marker-alt fa-3x mb-3"></i>
                    <p>No events currently visible on map.<br>Try adjusting your filters or zoom level.</p>
                </div>
            </div>

            <div id="all-events-container" style="display: none;">
                {% set next_ad_index = 2 %}
                {% set next_gap = 4 %}

                {% for event in events %}
                    <div class="card mb-3 event-card" 
                         data-event-id="{{ event.id }}"
                         data-lat="{{ event.latitude }}"
                         data-lng="{{ event.longitude }}"
                         data-category="{{ event.category }}"
                         data-date="{{ event.start_date }}"
                         data-fun-rating="{{ event.fun_rating }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ event.title }}</h5>
                            <p class="card-text small">{{ event.description|truncate(100) }}</p>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">{{ event.start_date }}</small>
                                <a href="{{ url_for('event_detail', event_id=event.id) }}" class="btn btn-sm btn-outline-primary">View</a>
                            </div>
                        </div>
                    </div>

                    {% if loop.index0 == next_ad_index %}
                    <div class="card mb-3 advertisement-card" data-ad-position="{{ loop.index }}">
                        <div class="card-body text-center">
                            <p class="ad-label">Advertisement</p>
                            <p>Sponsored Content - Advertisement space available</p>
                        </div>
                    </div>

                    {% set next_ad_index = next_ad_index + next_gap %}
                    {% set next_gap = next_gap + 1 %}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Add a hidden div to store event data for the map -->
<div id="map-data" style="display:none;" data-events="{{ events_json|tojson }}"></div>

<!-- Load map.js script -->
<script src="{{ url_for('static', filename='js/map.js') }}?v={{ range(1, 10000) | random }}"></script>

<script>
(function() {
    const MAP_BOUNDS = {
        north: parseFloat('{{ config.MAP_BOUNDS_NORTH|default(49.0)|float }}'),
        south: parseFloat('{{ config.MAP_BOUNDS_SOUTH|default(45.5)|float }}'),
        west: parseFloat('{{ config.MAP_BOUNDS_WEST|default(-124.8)|float }}'),
        east: parseFloat('{{ config.MAP_BOUNDS_EAST|default(-116.9)|float }}')
    };
    let visibleEventIds = [];
    let userMarker = null;

    function getEventsData() {
        if (window.FunlistMap && typeof FunlistMap.loadEventsFromDataset === "function") {
            const events = FunlistMap.loadEventsFromDataset();
            return Array.isArray(events) ? events : [];
        }
        return [];
    }

    const eventsData = getEventsData();

    function buildInfoContent(event) {
        if (window.FunlistMap && typeof FunlistMap.buildInfoContent === "function") {
            return FunlistMap.buildInfoContent(event);
        }

        const title = event.title || "Event";
        const description = event.description || "";
        const date = event.start_date || "";
        const ratingValue = event.fun_rating ?? event.fun_meter;
        const rating = Number.isFinite(ratingValue) ? `${ratingValue}/5` : "N/A";
        const detailLink = event.detail_url
            ? `<div class="mt-2"><a class="btn btn-sm btn-primary" href="${event.detail_url}">View Details</a></div>`
            : "";

        return `
            <div class="event-popup">
                <strong>${title}</strong><br>
                ${date ? `Date: ${date}<br>` : ""}
                ${description ? `${description.substring(0, 140)}...<br>` : ""}
                Fun Rating: ${rating}
                ${detailLink}
            </div>
        `;
    }

    function dateMatchesFilter(filterValue, eventDate) {
        const today = new Date();

        if (filterValue === "Today") {
            return eventDate.toDateString() === today.toDateString();
        }

        if (filterValue === "Tomorrow") {
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            return eventDate.toDateString() === tomorrow.toDateString();
        }

        if (filterValue === "This Weekend") {
            const dayOfWeek = today.getDay();
            const saturday = new Date(today);
            saturday.setDate(today.getDate() + ((6 - dayOfWeek + 7) % 7));
            const sunday = new Date(saturday);
            sunday.setDate(saturday.getDate() + 1);
            return eventDate >= saturday && eventDate <= sunday;
        }

        if (filterValue === "Next Week") {
            const nextMonday = new Date(today);
            const daysUntilMonday = (7 - today.getDay() + 1) % 7 || 7;
            nextMonday.setDate(today.getDate() + daysUntilMonday);

            const nextSunday = new Date(nextMonday);
            nextSunday.setDate(nextMonday.getDate() + 6);
            return eventDate >= nextMonday && eventDate <= nextSunday;
        }

        return true;
    }

    function filterMatches(event) {
        const category = document.getElementById('categoryFilter').value;
        const date = document.getElementById('dateFilter').value;
        const funRating = document.getElementById('funFilter').value;

        let passes = true;

        if (category && category !== 'All Categories') {
            passes = (event.category || "").toLowerCase() === category.toLowerCase();
        }

        if (passes && funRating && funRating !== 'All Fun Ratings') {
            const minRating = parseInt(funRating, 10);
            const rating = parseInt(event.fun_rating ?? event.fun_meter ?? 0, 10);
            if (rating < minRating) {
                passes = false;
            }
        }

        if (passes && date && date !== 'Any Date') {
            const eventDate = event.start_date ? new Date(event.start_date) : null;
            passes = !!eventDate && dateMatchesFilter(date, eventDate);
        }

        return passes;
    }

    function filterMarkers() {
        if (!window.FunlistMap) return;
        FunlistMap.filterMarkers(event => filterMatches(event));
        updateVisibleEvents();
    }

    function updateVisibleEvents() {
        if (!window.FunlistMap) return;

        visibleEventIds = FunlistMap.getVisibleEventIds();
        updateEventsList();

        const countElement = document.getElementById('event-count');
        if (countElement) {
            countElement.textContent = `${visibleEventIds.length} Events`;
        }

        const noEventsMessage = document.getElementById('no-events-message');
        if (noEventsMessage) {
            noEventsMessage.style.display = visibleEventIds.length > 0 ? 'none' : 'block';
        }
    }

    function updateEventsList() {
        const allEventsContainer = document.getElementById('all-events-container');
        const visibleEventsContainer = document.getElementById('visible-events-container');

        if (!allEventsContainer || !visibleEventsContainer) return;

        while (visibleEventsContainer.firstChild) {
            if (visibleEventsContainer.firstChild.id !== 'no-events-message') {
                visibleEventsContainer.removeChild(visibleEventsContainer.firstChild);
            } else {
                break;
            }
        }

        if (!visibleEventIds.length) {
            return;
        }

        const eventCards = allEventsContainer.querySelectorAll('.event-card, .advertisement-card');
        let visibleIndex = 0;

        eventCards.forEach(card => {
            if (card.classList.contains('event-card')) {
                const eventId = card.getAttribute('data-event-id');
                if (visibleEventIds.includes(eventId)) {
                    const cardClone = card.cloneNode(true);
                    cardClone.addEventListener('click', function(e) {
                        if (e.target.tagName !== 'A') {
                            highlightMarker(eventId);
                        }
                    });

                    visibleEventsContainer.appendChild(cardClone);
                    visibleIndex++;
                }
            } else if (card.classList.contains('advertisement-card')) {
                const adPosition = parseInt(card.getAttribute('data-ad-position'));
                if (visibleIndex + 1 === adPosition && visibleIndex < visibleEventIds.length) {
                    const adClone = card.cloneNode(true);
                    visibleEventsContainer.appendChild(adClone);
                }
            }
        });
    }

    function highlightMarker(eventId) {
        if (!window.FunlistMap) return;
        const marker = FunlistMap.highlightMarker(eventId, buildInfoContent);
        if (marker) {
            highlightEventCard(eventId);
        }
    }

    function highlightEventCard(eventId) {
        if (!eventId) return;

        document.querySelectorAll('.event-card').forEach(card => {
            card.classList.remove('highlighted');
        });

        const visibleCard = document.querySelector(`#visible-events-container .event-card[data-event-id="${eventId}"]`);
        if (visibleCard) {
            visibleCard.classList.add('highlighted');
            visibleCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }

    function wireEventCardClicks() {
        document.querySelectorAll('.event-card').forEach(card => {
            card.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    return;
                }
                const eventId = this.getAttribute('data-event-id');
                highlightMarker(eventId);
            });
        });
    }

    function getUserLocation(map) {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const coords = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    if (userMarker) {
                        userMarker.setMap(null);
                    }

                    userMarker = new google.maps.Marker({
                        position: coords,
                        map,
                        title: 'Your Location',
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: '#0d6efd',
                            fillOpacity: 0.9,
                            strokeColor: '#ffffff',
                            strokeOpacity: 1,
                            strokeWeight: 2,
                            scale: 7
                        }
                    });

                    map.panTo(coords);
                },
                error => {
                    console.warn("Error getting user location:", error.message);
                }
            );
        }
    }

    function bootstrapMap() {
        if (!window.google || !window.FunlistMap) {
            console.error("Google Maps or FunlistMap not available");
            return;
        }

        const map = FunlistMap.init('map', {
            events: eventsData,
            defaultBounds: MAP_BOUNDS,
            onMarkerClick: highlightEventCard,
            infoContentBuilder: buildInfoContent
        });

        if (!map) {
            return;
        }

        map.addListener('idle', updateVisibleEvents);

        const filterButton = document.getElementById('applyFilters');
        if (filterButton) {
            filterButton.addEventListener('click', filterMarkers);
        }

        wireEventCardClicks();
        updateVisibleEvents();
    }

    window.initMap = function() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', bootstrapMap);
        } else {
            bootstrapMap();
        }
    };
})();
</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&callback=initMap" async defer></script>
{% endblock %}
