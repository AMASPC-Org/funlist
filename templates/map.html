{% extends "base.html" %}

{% block title %}Map - FunList.ai{% endblock %}

{% block head %}
<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places" defer></script>
<style>
    body.map-page {
        padding-bottom: 0 !important;
    }

    #map {
        height: 750px;
        width: 100%;
    }

    .map-content-row {
        margin-bottom: 0;
    }

    .event-filter-bar {
        padding: 10px 0;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }

    .map-container {
        position: relative;
        height: 100%;
    }

    .user-location-button {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .map-sidebar {
        height: 750px;
        overflow-y: auto;
    }

    .map-event-card {
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .map-event-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Filter bar -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="row align-items-center">
                        <div class="col-md-3 mb-2 mb-md-0">
                            <div class="input-group">
                                <input type="text" id="locationSearchInput" class="form-control" placeholder="Search location">
                                <button class="btn btn-outline-secondary" type="button" id="searchLocationBtn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-2 mb-md-0">
                            <div class="d-flex justify-content-center">
                                <div class="btn-group me-2">
                                    <button id="filterToday" class="btn btn-outline-primary">Today</button>
                                    <button id="filterTomorrow" class="btn btn-outline-primary">Tomorrow</button>
                                    <button id="filterWeekend" class="btn btn-outline-primary">Weekend</button>
                                    <button id="filterAllEvents" class="btn btn-outline-primary active">All</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 d-flex justify-content-end">
                            <button id="userLocationButton" class="btn btn-primary">
                                <i class="fas fa-location-arrow me-1"></i> My Location
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map and event listing -->
    <div class="row map-content-row">
        <!-- Map container -->
        <div class="col-lg-8 px-0">
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>

        <!-- Event cards sidebar -->
        <div class="col-lg-4 map-sidebar bg-light p-3">
            <h4 class="mb-3">Events Near You</h4>
            <div id="event-cards-container" class="event-cards-container">
                {% if events %}
                    {% for event in events %}
                    <div class="card map-event-card" data-event-id="{{ event.id }}" data-lat="{{ event.latitude }}" data-lng="{{ event.longitude }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ event.title }}</h5>
                            <p class="card-text">
                                <i class="fas fa-calendar-alt me-2"></i>
                                {{ event.start_date.strftime('%B %d, %Y') }}
                                {% if not event.all_day and event.start_time %}
                                    at {{ event.start_time.strftime('%I:%M %p') }}
                                {% endif %}
                            </p>
                            <p class="card-text">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                {{ event.city }}, {{ event.state }}
                            </p>
                            <a href="{{ url_for('event_detail', event_id=event.id) }}" class="btn btn-sm btn-primary">View Details</a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">No events found in this area. Try adjusting your search or adding a new event!</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load map.js script which uses Google Maps -->
<script src="{{ url_for('static', filename='js/map.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add map-page class to body
        document.body.classList.add('map-page');

        // Initialize map after the page loads and Google Maps API is ready
        if (typeof google !== 'undefined' && typeof MapModule !== 'undefined') {
            MapModule.init('map');

            // Set up event cards to interact with map
            setupEventCards();

            // Set up filter buttons
            setupFilterButtons();

            // Setup user location button
            document.getElementById('userLocationButton').addEventListener('click', function() {
                MapModule.getUserLocation(function(position) {
                    MapModule.centerOnUserLocation(position.coords.latitude, position.coords.longitude);
                });
            });

            // Initialize location search if available
            if (MapModule.initializeLocationSearch) {
                MapModule.initializeLocationSearch('locationSearchInput');

                // Set up search button
                document.getElementById('searchLocationBtn').addEventListener('click', function() {
                    const searchInput = document.getElementById('locationSearchInput').value;
                    if (searchInput && MapModule.handleLocationSearch) {
                        MapModule.handleLocationSearch(searchInput);
                    }
                });
            }
        }

        function setupEventCards() {
            const eventCards = document.querySelectorAll('.map-event-card');
            eventCards.forEach(card => {
                card.addEventListener('click', function() {
                    const eventId = this.getAttribute('data-event-id');
                    const lat = parseFloat(this.getAttribute('data-lat'));
                    const lng = parseFloat(this.getAttribute('data-lng'));

                    if (!isNaN(lat) && !isNaN(lng)) {
                        MapModule.highlightMarker(eventId);
                        // Center map on this event
                        MapModule.centerOnUserLocation(lat, lng);
                    }
                });
            });
        }

        function setupFilterButtons() {
            const filterButtons = document.querySelectorAll('#filterToday, #filterTomorrow, #filterWeekend, #filterAllEvents');
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');

                    // Apply filter based on button id
                    const filterId = this.id;
                    let filter = '';

                    if (filterId === 'filterToday') {
                        filter = 'today';
                    } else if (filterId === 'filterTomorrow') {
                        filter = 'tomorrow';
                    } else if (filterId === 'filterWeekend') {
                        filter = 'weekend';
                    } else {
                        filter = 'all';
                    }

                    // Call the filter function from MapModule
                    MapModule.filterMarkers(filter);
                });
            });
        }
    });
</script>
{% endblock %}