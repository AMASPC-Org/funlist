
{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Event Map</h1>

    <div class="row mb-4">
        <div class="col-md-4">
            <select class="form-select" id="categoryFilter">
                <option value="">All Categories</option>
                <option value="music">Music</option>
                <option value="sports">Sports</option>
                <option value="arts">Arts</option>
                <option value="food">Food</option>
                <option value="other">Other</option>
            </select>
        </div>
        <div class="col-md-4">
            <input type="date" class="form-control" id="dateFilter">
        </div>
    </div>

    <div id="map" style="height: 600px;" class="mb-4"></div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    var map = L.map('map').setView([47.0379, -122.9007], 12);
    var markers = [];

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var events = [
        {% for event in events %}
        {
            id: {{ event.id }},
            title: "{{ event.title }}",
            date: "{{ event.date.strftime('%B %d, %Y at %I:%M %p') }}",
            category: "{{ event.category }}",
            latitude: {{ event.latitude }},
            longitude: {{ event.longitude }},
            description: "{{ event.description|truncate(100) }}",
            funMeter: {{ event.fun_meter }},
            url: "{{ url_for('event_detail', event_id=event.id) }}"
        },
        {% endfor %}
    ];

    function addMarkers(filteredEvents) {
        // Clear existing markers
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        // Add new markers
        filteredEvents.forEach(event => {
            var marker = L.marker([event.latitude, event.longitude])
                .bindPopup(`
                    <div class="event-popup">
                        <h5>${event.title}</h5>
                        <p>${event.date}</p>
                        <p>${event.description}</p>
                        <p><strong>Category:</strong> ${event.category}</p>
                        <p><strong>Fun Meter:</strong> ${event.funMeter}/5</p>
                        <a href="${event.url}" class="btn btn-primary btn-sm">View Details</a>
                    </div>
                `);
            markers.push(marker);
            marker.addTo(map);
        });
    }

    function filterEvents() {
        const category = document.getElementById('categoryFilter').value;
        const date = document.getElementById('dateFilter').value;
        
        let filteredEvents = events;
        
        if (category) {
            filteredEvents = filteredEvents.filter(event => event.category === category);
        }
        
        if (date) {
            const selectedDate = new Date(date).toDateString();
            filteredEvents = filteredEvents.filter(event => 
                new Date(event.date).toDateString() === selectedDate
            );
        }
        
        addMarkers(filteredEvents);
    }

    // Initialize markers
    addMarkers(events);

    // Add event listeners
    document.getElementById('categoryFilter').addEventListener('change', filterEvents);
    document.getElementById('dateFilter').addEventListener('change', filterEvents);
</script>

<style>
.event-popup {
    min-width: 200px;
}
.event-popup h5 {
    margin-bottom: 10px;
}
.event-popup p {
    margin-bottom: 5px;
}
</style>
{% endblock %}
