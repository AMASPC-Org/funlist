{% if not session.get('cookies_accepted') %}
<div id="cookie-consent-banner" class="cookie-banner" style="display: none;" role="alert" aria-live="polite">
    <div class="cookie-content">
        <p>We use cookies to enhance your experience. By continuing to visit this site you agree to our use of cookies. 
           <a href="#" data-bs-toggle="modal" data-bs-target="#cookieModal">Learn more</a>
        </p>
        <div class="cookie-buttons">
            <button id="accept-all-cookies" class="btn btn-primary btn-sm" type="button">Accept All</button>
            <button id="reject-non-essential-cookies" class="btn btn-outline-primary btn-sm" type="button">Reject Non-Essential</button>
            <button id="customize-cookies" class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#cookieModal">Customize</button>
        </div>
    </div>
</div>

<div class="modal fade" id="cookieModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cookie Preferences</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Manage how we use cookies to improve your experience on FunList.ai.</p>
                <form id="cookie-preferences-form">
                    <div class="cookie-settings">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="essential-cookies" checked disabled>
                            <label class="form-check-label" for="essential-cookies">
                                <strong>Essential Cookies</strong>
                                <p class="text-muted small">Required for the website to function. Cannot be disabled.</p>
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="analytics-cookies">
                            <label class="form-check-label" for="analytics-cookies">
                                <strong>Analytics Cookies</strong>
                                <p class="text-muted small">Help us improve our website by collecting anonymous usage data.</p>
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="advertising-cookies">
                            <label class="form-check-label" for="advertising-cookies">
                                <strong>Advertising Cookies</strong>
                                <p class="text-muted small">Used to show you relevant advertisements across other websites.</p>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-cookie-preferences">Save Preferences</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // Add a small delay to ensure all DOM elements are loaded
        setTimeout(() => {
            initCookieConsent();
        }, 100);
    });

    function initCookieConsent() {
        const cookieConsent = document.getElementById('cookie-consent-banner');
        if (!cookieConsent) {
            console.log('Cookie banner element not found');
            return;
        }

        // Check if consent already exists in localStorage (most reliable)
        const hasLocalConsent = localStorage.getItem('cookieConsent');
        const hasSessionConsent = {{ 'true' if session.get('cookies_accepted') else 'false' }};

        console.log('Cookie consent check:', {
            localStorage: !!hasLocalConsent,
            session: hasSessionConsent
        });

        // Check localStorage first
        if (hasLocalConsent) {
            try {
                const consentData = JSON.parse(hasLocalConsent);
                const now = new Date().getTime();

                // Check if consent has expired (6 months)
                if (consentData.expires && now > consentData.expires) {
                    console.log('Cookie consent expired, clearing and showing banner');
                    localStorage.removeItem('cookieConsent');
                    deleteCookie('cookieConsentAccepted');
                    showCookieBanner();
                    setupCookieButtons();
                    return;
                }

                // Valid consent found
                console.log('Valid localStorage consent found, hiding banner');
                hideCookieBanner();

                if (consentData.preferences) {
                    applyCookieSettings(consentData.preferences);
                }
                return;

            } catch (error) {
                console.error("Error parsing localStorage consent:", error);
                localStorage.removeItem('cookieConsent');
            }
        }

        // Check session consent
        if (hasSessionConsent) {
            console.log('Session consent found, hiding banner');
            hideCookieBanner();
            return;
        }

        // No consent found, show the banner
        console.log('No cookie consent found, showing banner');
        showCookieBanner();
        setupCookieButtons();
    }

    function showCookieBanner() {
        const cookieConsent = document.getElementById('cookie-consent-banner');
        if (cookieConsent) {
            console.log('Showing cookie consent banner');
            cookieConsent.style.display = 'block';
            document.body.classList.add('cookie-consent-visible');
        }
    }

    function setupCookieButtons() {
        // Accept all button
        const acceptAllBtn = document.getElementById('accept-all-cookies');
        if (acceptAllBtn) {
            acceptAllBtn.addEventListener('click', function() {
                console.log('Accept All button clicked');

                const preferences = {
                    essential: true,
                    analytics: true,
                    advertising: true
                };

                // Get CSRF token from meta tag or form
                const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || 
                                document.querySelector('input[name="csrf_token"]')?.value;
                const headers = {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                };

                if (csrfToken) {
                    headers['X-CSRFToken'] = csrfToken;
                }

                console.log('CSRF Token found:', !!csrfToken);

                console.log('Sending cookie acceptance request to server...');

                // Send to server
                fetch('/accept-cookies', { 
                    method: 'POST',
                    headers: headers,
                    credentials: 'same-origin'
                })
                .then(response => {
                    console.log('Server response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Server response data:', data);
                    if (data.status === 'success') {
                        saveCookiePreferences(preferences);
                        hideCookieBanner();
                        console.log('Cookie acceptance successful');
                    } else {
                        throw new Error(data.message || 'Server returned error status');
                    }
                })
                .catch(error => {
                    console.error('Error accepting cookies:', error);
                    // Still save locally if server fails
                    console.log('Falling back to local storage only');
                    saveCookiePreferences(preferences);
                    hideCookieBanner();
                });
            });
        }

        // Reject non-essential button
        const rejectBtn = document.getElementById('reject-non-essential-cookies');
        if (rejectBtn) {
            rejectBtn.addEventListener('click', function() {
                console.log('Reject Non-Essential button clicked');

                const preferences = {
                    essential: true,
                    analytics: false,
                    advertising: false
                };

                // Get CSRF token from meta tag or form
                const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || 
                                document.querySelector('input[name="csrf_token"]')?.value;
                const headers = {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                };

                if (csrfToken) {
                    headers['X-CSRFToken'] = csrfToken;
                }

                console.log('CSRF Token found:', !!csrfToken);

                // Send to server
                fetch('/save-cookie-preferences', {
                    method: 'POST',
                    headers: headers,
                    credentials: 'same-origin',
                    body: JSON.stringify({ preferences: preferences })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Cookie preferences saved:', data);
                    if (data.status === 'success') {
                        saveCookiePreferences(preferences);
                        hideCookieBanner();
                    } else {
                        throw new Error(data.message || 'Server returned error status');
                    }
                })
                .catch(error => {
                    console.error('Error saving cookie preferences:', error);
                    // Still save locally if server fails
                    saveCookiePreferences(preferences);
                    hideCookieBanner();
                });
            });
        }

        // Save preferences button in the modal
        const savePrefsBtn = document.getElementById('save-cookie-preferences');
        if (savePrefsBtn) {
            savePrefsBtn.addEventListener('click', function() {
                const preferences = {
                    essential: true,
                    analytics: document.getElementById('analytics-cookies').checked,
                    advertising: document.getElementById('advertising-cookies').checked
                };

                fetch('/save-cookie-preferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ preferences: preferences })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Cookie preferences saved:', data);
                    if (data.status === 'success') {
                        saveCookiePreferences(preferences);
                        hideCookieBanner();
                        const cookieModal = bootstrap.Modal.getInstance(document.getElementById('cookieModal'));
                        if (cookieModal) {
                            cookieModal.hide();
                        }
                    } else {
                        throw new Error(data.message || 'Server returned error status');
                    }
                })
                .catch(error => {
                    console.error('Error saving cookie preferences:', error);
                    // Still save locally if server fails
                    saveCookiePreferences(preferences);
                    hideCookieBanner();
                });
            });
        }
    }

    function saveCookiePreferences(preferences) {
        try {
            // Save to localStorage with expiration of 6 months
            const sixMonths = 180 * 24 * 60 * 60 * 1000;
            const expirationDate = new Date().getTime() + sixMonths;

            const consentData = {
                preferences: preferences,
                expires: expirationDate,
                timestamp: new Date().getTime(),
                version: '1.0'
            };

            localStorage.setItem('cookieConsent', JSON.stringify(consentData));

            // Also set regular cookies as backup (expires in 6 months)
            setCookie('cookieConsentAccepted', 'true', 180);
            setCookie('cookiePreferences', JSON.stringify(preferences), 180);

            // Apply cookie settings immediately
            applyCookieSettings(preferences);

            console.log('Cookie preferences saved successfully:', preferences);
        } catch (error) {
            console.error("Error saving cookie preferences:", error);
            // Fallback to just setting basic cookie if localStorage fails
            setCookie('cookieConsentAccepted', 'true', 180);
        }
    }

    // Helper function to set cookies
    function setCookie(name, value, days) {
        let expires = '';
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = '; expires=' + date.toUTCString();
        }
        // Use Lax for better compatibility, ensure path is set
        document.cookie = name + '=' + encodeURIComponent(value || '') + expires + '; path=/; SameSite=Lax';
        console.log('Cookie set:', name, '=', value);
    }

    // Helper function to get cookie values
    function getCookie(name) {
        const nameEQ = name + '=';
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    // Helper function to delete cookies
    function deleteCookie(name) {
        document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax';
    }

    function applyCookieSettings(preferences) {
        try {
            if (preferences && preferences.analytics) {
                console.log('Analytics tracking enabled');
                // Enable analytics code here
            }

            if (preferences && preferences.advertising) {
                console.log('Advertising cookies enabled');
                // Enable advertising code here
            }
        } catch (error) {
            console.error("Error applying cookie settings:", error);
        }
    }

    function hideCookieBanner() {
        try {
            const cookieBanner = document.getElementById('cookie-consent-banner');
            if (cookieBanner) {
                cookieBanner.style.display = 'none';
                document.body.classList.remove('cookie-consent-visible');
                console.log('Cookie banner hidden');
            }
        } catch (error) {
            console.error("Error hiding cookie banner:", error);
        }
    }
</script>
{% endif %}