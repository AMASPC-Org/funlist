{% extends "base.html" %}

{% block title %}{{ event.title }} - {{ event.city }}, {{ event.state }} | FunList.ai{% endblock %}

{% block description %}Join {{ event.title }} in {{ event.city }}, {{ event.state }} on {{ event.start_date.strftime('%B %d, %Y') }}. {{ event.description[:150] }}...{% endblock %}

{% block keywords %}{{ event.title }}, {{ event.city }} events, {{ event.state }} events, {{ event.category }} events, local events, community events{% endblock %}

{% block og_type %}article{% endblock %}
{% block og_title %}{{ event.title }} - {{ event.city }}, {{ event.state }}{% endblock %}
{% block og_description %}{{ event.description[:200] }}{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Event",
      "@id": "{{ request.url }}#event",
      "name": "{{ event.title }}",
      "description": "{{ event.description|safe }}",
      "startDate": "{{ event.start_date.isoformat() if event.start_date }}",
      "endDate": "{{ event.end_date.isoformat() if event.end_date else event.start_date.isoformat() if event.start_date }}",
      "eventStatus": "https://schema.org/EventScheduled",
      "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
      "location": {
        "@type": "Place",
        "@id": "{{ request.url }}#place",
        "name": "{{ event.location or event.city + ', ' + event.state }}",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "{{ event.city }}",
          "addressRegion": "{{ event.state }}",
          "addressCountry": "US"
        }{% if event.latitude and event.longitude %},
        "geo": {
          "@type": "GeoCoordinates",
          "latitude": {{ event.latitude }},
          "longitude": {{ event.longitude }}
        }{% endif %}
      },
      "organizer": {
        "@type": "Organization",
        "name": "{{ event.organizer_name or 'Community Organizer' }}"
      },
      "audience": {
        "@type": "Audience",
        "audienceType": "families, community members, local residents"
      },
      "image": {
        "@type": "ImageObject",
        "url": "{{ url_for('static', filename='images/Have-Fun-FunList.ai-home.jpeg', _external=True) }}",
        "width": 1200,
        "height": 630
      },
      "url": "{{ request.url }}",
      "mainEntityOfPage": "{{ request.url }}",
      "publisher": {
        "@type": "Organization",
        "name": "FunList.ai",
        "logo": "{{ url_for('static', filename='images/logo.png', _external=True) }}"
      },
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD",
        "availability": "https://schema.org/InStock",
        "url": "{{ request.url }}"
      }{% if event.fun_meter %},
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": {{ event.fun_meter }},
        "bestRating": 5,
        "worstRating": 1,
        "ratingCount": 1,
        "reviewAspect": "Funalytics Fun Rating - AI-powered community engagement and family-friendliness score"
      }{% endif %}{% if event.category %},
      "genre": "{{ event.category }}",
      "additionalType": "https://schema.org/{{ event.category.capitalize() }}Event"{% endif %}
    },
    {
      "@type": "BreadcrumbList",
      "@id": "{{ request.url }}#breadcrumb",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "{{ url_for('index', _external=True) }}"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Events",
          "item": "{{ url_for('events', _external=True) }}"
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": "{{ event.title }}",
          "item": "{{ request.url }}"
        }
      ]
    }
  ]
}
</script>

<!-- LLM-Optimized Event Knowledge -->
<div class="d-none" itemscope itemtype="https://schema.org/Event">
    <h1 itemprop="name">{{ event.title }}</h1>
    <div itemprop="description">{{ event.description|safe }}</div>
    <meta itemprop="startDate" content="{{ event.start_date.isoformat() if event.start_date }}">
    <meta itemprop="endDate" content="{{ event.end_date.isoformat() if event.end_date else event.start_date.isoformat() if event.start_date }}">

    <div itemprop="location" itemscope itemtype="https://schema.org/Place">
        <span itemprop="name">{{ event.location or event.city + ', ' + event.state }}</span>
        <div itemprop="address" itemscope itemtype="https://schema.org/PostalAddress">
            <span itemprop="addressLocality">{{ event.city }}</span>
            <span itemprop="addressRegion">{{ event.state }}</span>
        </div>
    </div>

    {% if event.fun_meter %}
    <div itemprop="aggregateRating" itemscope itemtype="https://schema.org/AggregateRating">
        <span itemprop="ratingValue">{{ event.fun_meter }}</span> out of 
        <span itemprop="bestRating">5</span> stars 
        <span itemprop="reviewAspect">Funalytics Fun Rating</span>
    </div>
    {% endif %}

    <meta itemprop="eventStatus" content="https://schema.org/EventScheduled">
    <meta itemprop="eventAttendanceMode" content="https://schema.org/OfflineEventAttendanceMode">

    <!-- Enhanced event context for LLMs -->
    <div class="event-context">
        <p>This {{ event.category or 'community' }} event is part of FunList.ai's curated collection of family-friendly activities in {{ event.city }}, {{ event.state }}. Events are scored using our proprietary Funalytics system which evaluates CommunityVibe and FamilyFun metrics to help families discover engaging local experiences.</p>

        {% if event.fun_meter >= 4 %}
        <p>This event has received a high Funalytics fun rating of {{ event.fun_meter }}/5, indicating strong community engagement potential and family-friendly appeal.</p>
        {% endif %}

        <p>FunList.ai serves the Pacific Northwest community by connecting families with local events that strengthen community bonds and provide meaningful shared experiences.</p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title">{{ event.title }}</h1>
                    <div class="event-meta mb-3">
                        <span class="badge bg-primary">{{ event.category|capitalize }}</span>
                        <span class="badge bg-info">{{ event.target_audience|capitalize }}</span>

                        {% if event.funalytics %}
                            <!-- Funalytics Scores -->
                            <span class="badge bg-warning">
                                <i class="fas fa-brain"></i> Funalytics: {{ event.funalytics.overallScore }}/10
                            </span>
                            <span class="badge bg-info">
                                <i class="fas fa-users"></i> Community: {{ event.funalytics.communityVibe }}/10
                            </span>
                            <span class="badge bg-success">
                                <i class="fas fa-child"></i> Family: {{ event.funalytics.familyFun }}/10
                            </span>
                        {% else %}
                            <!-- Fallback to old fun rating -->
                            <span class="badge bg-warning">Fun Rating: {{ "‚≠ê" * event.fun_meter }}</span>
                        {% endif %}
                    </div>

                    <div class="event-description mb-4">
                        {{ event.description }}
                    </div>

                    {% if event.funalytics %}
                    <div class="funalytics-reasoning mb-4">
                        <h5><i class="fas fa-lightbulb"></i> Funalytics Analysis</h5>
                        <div class="card bg-light">
                            <div class="card-body">
                                <p class="mb-2"><strong>Analysis:</strong> {{ event.funalytics.reasoning }}</p>
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> Last computed: Recently
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="event-details">
                        <h4>Event Details</h4>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-calendar"></i> Start: {{ event.start_date.strftime('%B %d, %Y') }}
                                {% if event.start_time %}at {{ event.start_time.strftime('%I:%M %p') }}{% endif %}</li>
                            <li><i class="fas fa-calendar-check"></i> End: {{ event.end_date.strftime('%B %d, %Y') }}
                                {% if event.end_time %}at {{ event.end_time.strftime('%I:%M %p') }}{% endif %}</li>
                            <li><i class="fas fa-map-marker-alt"></i> {{ event.street }}, {{ event.city }}, {{ event.state }} {{ event.zip_code }}</li>
                        </ul>
                    </div>

                    <div class="social-share mt-4">
                        <h4>Share This Event</h4>
                        <div class="share-buttons">
                            <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url|urlencode }}" 
                               class="btn btn-facebook" target="_blank">
                                <i class="fab fa-facebook"></i> Share
                            </a>
                            <a href="https://twitter.com/intent/tweet?text={{ event.title|urlencode }}&url={{ request.url|urlencode }}" 
                               class="btn btn-twitter" target="_blank">
                                <i class="fab fa-twitter"></i> Tweet
                            </a>
                            <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.url|urlencode }}&title={{ event.title|urlencode }}" 
                               class="btn btn-linkedin" target="_blank">
                                <i class="fab fa-linkedin"></i> Share
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-body">
                    <div id="eventMap" style="height: 300px;"></div>
                </div>
            </div>

            {% if event.website or event.facebook or event.instagram or event.twitter %}
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Event Links</h5>
                    <div class="event-links">
                        {% if event.website %}
                        <a href="{{ event.website }}" class="btn btn-outline-primary btn-block mb-2" target="_blank">
                            <i class="fas fa-globe"></i> Official Website
                        </a>
                        {% endif %}
                        {% if event.facebook %}
                        <a href="{{ event.facebook }}" class="btn btn-outline-facebook btn-block mb-2" target="_blank">
                            <i class="fab fa-facebook"></i> Facebook
                        </a>
                        {% endif %}
                        {% if event.instagram %}
                        <a href="{{ event.instagram }}" class="btn btn-outline-instagram btn-block mb-2" target="_blank">
                            <i class="fab fa-instagram"></i> Instagram
                        </a>
                        {% endif %}
                        {% if event.twitter %}
                        <a href="{{ event.twitter }}" class="btn btn-outline-twitter btn-block" target="_blank">
                            <i class="fab fa-twitter"></i> Twitter
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if current_user.is_authenticated %}
            <div class="card">
                <div class="card-body">
                    <div class="event-actions">
                        <button class="btn btn-primary btn-block mb-2">
                            <i class="far fa-star"></i> Express Interest
                        </button>
                        <button class="btn btn-success btn-block mb-2">
                            <i class="far fa-check-circle"></i> Mark as Attended
                        </button>

                        {% if current_user.is_admin %}
                        <form method="POST" action="{{ url_for('admin_recompute_funalytics', event_id=event.id) }}" class="mt-2">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-outline-secondary btn-block">
                                <i class="fas fa-sync-alt"></i> Recompute Funalytics Score
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var map = L.map('eventMap').setView([{{ event.latitude }}, {{ event.longitude }}], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    L.marker([{{ event.latitude }}, {{ event.longitude }}])
        .bindPopup("{{ event.title }}")
        .addTo(map);
});
</script>
{% endblock %}